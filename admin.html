<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¹»å½±åœ¨çº¿ - ç®¡ç†é¢æ¿</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --primary-color: #007aff;
            --primary-color-light: #e5f2ff;
            --background-color: #f7f8fc;
            --surface-color: #ffffff;
            --text-color: #1d1d1f;
            --text-color-secondary: #6e6e73;
            --border-color: #e1e4e8;
            --border-radius: 10px;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --transition-speed: 0.25s;
        }
        body { font-family: var(--font-family); background-color: var(--background-color); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: row; color: var(--text-color); font-size: 14px; -webkit-font-smoothing: antialiased; }
        svg { width: 1.2em; height: 1.2em; vertical-align: -0.25em; margin-right: 12px; }
        .sidebar { width: 240px; background-color: var(--surface-color); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; padding: 20px 0; }
        .sidebar-header { padding: 0 24px 24px 24px; font-size: 20px; font-weight: 700; display: flex; align-items: center; color: var(--primary-color); }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a { display: flex; align-items: center; padding: 14px 24px; margin: 4px 16px; text-decoration: none; color: var(--text-color-secondary); font-weight: 500; border-radius: 8px; transition: all var(--transition-speed) ease; }
        .sidebar-nav a:hover { background-color: var(--background-color); color: var(--text-color); }
        .sidebar-nav a.active { background-color: var(--primary-color-light); color: var(--primary-color); font-weight: 600; }
        .sidebar-nav a.active svg { color: var(--primary-color); }
        .sidebar-footer { padding: 24px; font-size: 12px; color: var(--text-color-secondary); display: flex; align-items: center; border-top: 1px solid var(--border-color); }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .titlebar { -webkit-app-region: drag; height: 64px; display: flex; justify-content: space-between; align-items: center; padding: 0 28px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .titlebar-title { -webkit-app-region: no-drag; font-weight: 600; font-size: 20px; }
        .window-controls button { -webkit-app-region: no-drag; background: transparent; border: none; width: 36px; height: 36px; color: var(--text-color-secondary); cursor: pointer; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; transition: background-color var(--transition-speed) ease; }
        .window-controls button:hover { background-color: var(--background-color); color: var(--text-color); }
        .content-pane { flex-grow: 1; overflow-y: auto; padding: 32px; }
        .view { display: none; animation: 0.4s fadeIn; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .client-card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 20px; transition: all var(--transition-speed) ease; }
        .client-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .client-card.status-locked .client-card-header .client-card-user { color: var(--danger-color); }
        .client-card.status-online .client-card-header .client-card-user { color: var(--success-color); }
        .client-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .client-card-user { font-size: 18px; font-weight: 600; }
        .client-card-status { font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 16px; }
        .client-card-status.status-locked { background-color: var(--danger-color); color: white; }
        .client-card-status.status-online { background-color: var(--success-color); color: white; }
        .client-card-body { display: grid; grid-template-columns: 100px 1fr; gap: 12px; font-size: 14px; }
        .client-card-body .label { color: var(--text-color-secondary); }
        .client-card-body .value { font-weight: 600; font-family: monospace, 'Inter'; }
        .client-card-actions { margin-top: 20px; display: flex; gap: 8px; }
        .client-card-actions button { flex-grow: 1; padding: 10px; font-size: 13px; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--text-color-secondary); }
        .client-card-actions button:hover { background-color: #e8e9ec; color: var(--text-color); border-color: #d8dbe0; }
        .card { background-color: var(--surface-color); border-radius: var(--border-radius); padding: 28px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .card h2 { font-size: 22px; font-weight: 700; margin: 0 0 28px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 16px; border-bottom: 1px solid var(--border-color); }
        th { font-size: 12px; color: var(--text-color-secondary); font-weight: 600; background-color: var(--background-color); text-transform: uppercase; letter-spacing: 0.5px; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #fafbfc; }
        button, .button { padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; transition: all var(--transition-speed) ease; }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { filter: brightness(1.15); transform: translateY(-1px); }
        button.secondary { background-color: #e8e9ec; color: var(--text-color); border: 1px solid var(--border-color); }
        button.secondary:hover { background-color: #dfe1e5; }
        .actions button { background: transparent; color: var(--text-color-secondary); padding: 6px 10px; font-size: 13px; }
        .actions button:hover { background-color: var(--background-color); color: var(--text-color); }
        .form-row { margin-bottom: 20px; }
        .form-row label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; }
        .form-row input { width: 100%; box-sizing: border-box; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background-color: var(--background-color); }
        .form-row input:focus { outline: none; border-color: var(--primary-color); background-color: var(--surface-color); box-shadow: 0 0 0 3px var(--primary-color-light); }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px; }
        .stats-card { background-color: var(--surface-color); border-radius: var(--border-radius); padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all var(--transition-speed) ease; }
        .stats-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stats-label { font-size: 13px; color: var(--text-color-secondary); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stats-value { font-size: 20px; font-weight: 700; color: var(--text-color); font-family: monospace, 'Inter'; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.2s; }
        .modal.visible { display: flex; }
        .modal-content { padding: 32px; background-color: var(--surface-color); border-radius: 12px; width: 440px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <svg width="0" height="0" style="display:none;">
        <defs>
            <symbol id="icon-console" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></symbol>
            <symbol id="icon-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></symbol>
            <symbol id="icon-users" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
            <symbol id="icon-finance" viewBox="0 0 24 24"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></symbol>
            <symbol id="icon-logs" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></symbol>
            <symbol id="icon-add" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
            <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z"/></symbol>
            <symbol id="icon-delete" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2H8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        </defs>
    </svg>
    <div class="sidebar">
        <div class="sidebar-header">å¹»å½±åœ¨çº¿</div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-view="console"><svg><use href="#icon-console"/></svg>æ§åˆ¶å°</a>
            <a href="#" class="nav-item" data-view="devices"><svg><use href="#icon-dashboard"/></svg>è®¾å¤‡æ¦‚è§ˆ</a>
            <a href="#" class="nav-item" data-view="users"><svg><use href="#icon-users"/></svg>ç”¨æˆ·ç®¡ç†</a>
            <a href="#" class="nav-item" data-view="finance"><svg><use href="#icon-finance"/></svg>è´¢åŠ¡ä¸­å¿ƒ</a>
            <a href="#" class="nav-item" data-view="logs"><svg><use href="#icon-logs"/></svg>ç³»ç»Ÿæ—¥å¿—</a>
        </nav>
        <div class="sidebar-footer">
            <div id="network-indicator"></div><span id="status" style="margin-left: 8px;"></span>
        </div>
    </div>
    <div class="main-container">
        <div class="titlebar">
            <div id="view-title" class="titlebar-title">æ§åˆ¶å°</div>
            <div class="window-controls"><button id="pin-btn" title="ç½®é¡¶">ğŸ“Œ</button><button id="minimize-btn" title="æœ€å°åŒ–">-</button><button id="maximize-btn" title="æœ€å¤§åŒ–">+</button><button id="close-btn" title="å…³é—­">Ã—</button></div>
        </div>
        <div class="content-pane">
            <div id="view-console" class="view active">
                <div class="card">
                    <h2>æœåŠ¡ç«¯æ—¥å¿—</h2>
                    <pre id="server-log" style="background-color: #2d2d2d; color: #f0f0f0; padding: 16px; border-radius: 8px; height: 450px; overflow-y: auto; font-family: monospace;">æœåŠ¡ç«¯å¯åŠ¨æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</pre>
                </div>
            </div>
            <div id="view-devices" class="view"><div id="device-grid" class="device-grid"></div></div>
            <div id="view-users" class="view"><div class="card"><h2>ç”¨æˆ·ç®¡ç†</h2><table id="all-users-table"><thead><tr><th>ç”¨æˆ·å</th><th>è´¹ç‡ (å…ƒ/å°æ—¶)</th><th>ä½™é¢</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div>
            <div id="view-finance" class="view"><div class="card"><h2>ç”¨æˆ·å……å€¼</h2><div class="form-row"><label>ç”¨æˆ·å</label><input id="recharge-username" placeholder="è¦å……å€¼çš„ç”¨æˆ·å"></div><div class="form-row"><label>é‡‘é¢</label><input id="recharge-amount" type="number" placeholder="å……å€¼é‡‘é¢"></div><button onclick="window.recharge()" class="primary">ç¡®è®¤å……å€¼</button></div><div class="card" style="margin-top: 24px;"><h2>è¥æ”¶ç»Ÿè®¡</h2><div id="stats-controls" style="margin-bottom: 16px; display: flex; gap: 8px;"><button class="secondary" onclick="window.updateStats('today')">ä»Šæ—¥</button><button class="secondary" onclick="window.updateStats('week')">æœ¬å‘¨</button><button class="secondary" onclick="window.updateStats('month')">æœ¬æœˆ</button><button class="secondary" onclick="window.updateStats('all')">å…¨éƒ¨</button></div><div id="stats-grid" class="grid-container"></div></div></div>
            <div id="view-logs" class="view"><div class="card"><h2>ç³»ç»Ÿæ—¥å¿—</h2><table id="logs-table"><thead><tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>äº‹ä»¶</th><th>è¯¦æƒ…</th></tr></thead><tbody></tbody></table></div></div>

        </div>
    </div>
    <div id="user-modal" class="modal"><div class="modal-content"><h2 id="modal-title">æ·»åŠ æ–°ç”¨æˆ·</h2><div class="form-row"><label>ç”¨æˆ·å</label><input id="modal-username"></div><div class="form-row"><label>å¯†ç </label><input id="modal-password" type="password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹"></div><div class="form-row"><label>è´¹ç‡ (å…ƒ/å°æ—¶)</label><input id="modal-rate" type="number" step="0.1"></div><div class="form-actions" style="text-align:right; margin-top:24px;"><button class="secondary" onclick="window.closeUserModal()">å–æ¶ˆ</button><button class="primary" onclick="window.saveUser()" style="margin-left:8px;">ä¿å­˜</button></div></div></div>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const viewTitle = document.getElementById('view-title');
            const navLinks = document.querySelectorAll('.nav-item');
            const views = document.querySelectorAll('.view');
            const userModal = document.getElementById('user-modal');
            const statusEl = document.getElementById('status');
            const indicatorEl = document.getElementById('network-indicator');
            let isEditMode = false, editUsername = null;
            window.allUsers = {};

            const pinBtn = document.getElementById('pin-btn');
            pinBtn.addEventListener('click', async () => pinBtn.classList.toggle('pinned', await window.electronAPI.invoke('toggle-always-on-top')));
            document.getElementById('minimize-btn').addEventListener('click', () => window.electronAPI.send('minimize-window'));
            document.getElementById('maximize-btn').addEventListener('click', () => window.electronAPI.send('maximize-window'));
            document.getElementById('close-btn').addEventListener('click', () => window.electronAPI.send('close-window'));

            function openView(viewId) {
                views.forEach(v => v.classList.remove('active'));
                navLinks.forEach(l => l.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                const activeLink = document.querySelector(`.nav-item[data-view="${viewId}"]`);
                activeLink.classList.add('active');
                viewTitle.textContent = activeLink.textContent;
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    openView(e.currentTarget.dataset.view);
                });
            });

            


            async function apiCall(endpoint, method, body) {
                try {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) opts.body = JSON.stringify(body);
                    const response = await fetch(`http://localhost:3000/api${endpoint}`, opts);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                } catch (error) {
                    console.error("API Call Error:", error);
                    return { success: false, message: `è¯·æ±‚å¤±è´¥: ${error.message}` };
                }
            }

            function updateUI(data) {
                window.allUsers = data.allUsers;
                updateDeviceGrid(data.clients);
                updateUsersTable(data.allUsers);
                updateLogsTable(data.session_logs);
            }

            function updateDeviceGrid(clients) {
                const grid = document.getElementById('device-grid');
                grid.innerHTML = '';
                if (clients.length === 0) {
                    grid.innerHTML = `<div class="card"><p style="text-align: center; color: var(--text-color-secondary); padding: 40px 0;">æ²¡æœ‰åœ¨çº¿è®¾å¤‡</p></div>`;
                    return;
                }
                clients.forEach(c => {
                    const card = document.createElement('div');
                    card.className = `client-card status-${c.isLocked ? 'locked' : 'online'}`;
                    card.innerHTML = `
                        <div class="client-card-header">
                            <div class="client-card-user">${c.username}</div>
                            <div class="client-card-status status-${c.isLocked ? 'locked' : 'online'}">${c.isLocked ? 'å·²é”å®š' : 'åœ¨çº¿'}</div>
                        </div>
                        <div class="client-card-body">
                            <div class="label">ä¸Šæœºæ—¶é—´</div><div class="value">${new Date(c.startTime).toLocaleTimeString()}</div>
                            <div class="label">å½“å‰ä½™é¢</div><div class="value">Â¥${(c.balance || 0).toFixed(2)}</div>
                        </div>
                        <div class="client-card-actions">
                            <button onclick="window.controlClient('${c.username}', '${c.isLocked ? 'unlock' : 'lock'}')">${c.isLocked ? 'è§£é”' : 'é”å®š'}</button>
                            <button onclick="window.controlClient('${c.username}', 'reboot')">é‡å¯</button>
                            <button onclick="window.controlClient('${c.username}', 'shutdown')">å…³æœº</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            function updateUsersTable(users) {
                const tbody = document.querySelector('#all-users-table tbody');
                tbody.innerHTML = Object.keys(users).length ? '' : '<tr><td colspan="4" style="text-align:center; padding: 40px;">æ²¡æœ‰ç”¨æˆ·</td></tr>';
                for (const username in users) {
                    const user = users[username];
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${username}</td><td>${user.rate.toFixed(2)}</td><td>${user.balance.toFixed(2)}</td>`;
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'actions';
                    actionsCell.innerHTML = `<button onclick="window.openUserModal('${username}')"><svg><use href="#icon-edit"/></svg>ç¼–è¾‘</button><button onclick="window.deleteUser('${username}')"><svg><use href="#icon-delete"/></svg>åˆ é™¤</button>`;
                }
            }

            function updateLogsTable(logs) {
                const tbody = document.querySelector('#logs-table tbody');
                tbody.innerHTML = logs.length ? '' : '<tr><td colspan="4" style="text-align:center; padding: 40px;">æ²¡æœ‰æ—¥å¿—</td></tr>';
                logs.forEach(log => {
                    const row = tbody.insertRow();
                    const cost = log.cost || 0;
                    const duration = log.duration || 0;
                    row.innerHTML = `<td>${new Date(log.endTime).toLocaleString()}</td><td>${log.username}</td><td>ä¼šè¯ç»“æŸ</td><td>æ—¶é•¿: ${duration}åˆ†, æ¶ˆè´¹: Â¥${cost.toFixed(2)}</td>`;
                });
            }
            
            window.controlClient = (username, action) => apiCall(`/control/${username}`, 'POST', { action });

            window.updateStats = async (period = 'today') => {
                try {
                    const result = await apiCall(`/stats?period=${period}`, 'GET');
                    if (result.success) {
                        updateStatsGrid(result.stats);
                    } else {
                        alert(`è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${result.message}`);
                    }
                } catch (error) {
                    alert('è·å–ç»Ÿè®¡ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯');
                }
            };

            function updateStatsGrid(stats) {
                const grid = document.getElementById('stats-grid');
                grid.innerHTML = '';
                
                const statsCards = [
                    { label: 'ç»Ÿè®¡å‘¨æœŸ', value: `${stats.startDate} è‡³ ${stats.endDate}` },
                    { label: 'æ€»ä¼šè¯æ•°', value: stats.totalSessions },
                    { label: 'æ€»æ—¶é•¿', value: `${stats.totalDuration} åˆ†é’Ÿ` },
                    { label: 'æ€»è¥æ”¶', value: `Â¥${stats.totalRevenue.toFixed(2)}` }
                ];

                statsCards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'stats-card';
                    cardEl.innerHTML = `
                        <div class="stats-label">${card.label}</div>
                        <div class="stats-value">${card.value}</div>
                    `;
                    grid.appendChild(cardEl);
                });
            }

            window.recharge = async () => {
                const username = document.getElementById('recharge-username').value;
                const amountInput = document.getElementById('recharge-amount');
                const amount = parseFloat(amountInput.value);

                if (!username) { return alert('è¯·è¾“å…¥ç”¨æˆ·å'); }
                if (isNaN(amount) || amount <= 0) { return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢'); }

                const result = await apiCall('/recharge', 'POST', { username, amount });
                if (result.success) {
                    alert('å……å€¼æˆåŠŸ');
                    amountInput.value = '';
                } else {
                    alert(`å……å€¼å¤±è´¥: ${result.message}`);
                }
            };

            window.deleteUser = async (username) => {
                if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`)) {
                    const result = await apiCall(`/users/${username}`, 'DELETE');
                    if (result.success) {
                        alert('ç”¨æˆ·å·²åˆ é™¤');
                    } else {
                        alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                    }
                }
            };

            window.openUserModal = (username = null) => {
                isEditMode = !!username;
                editUsername = username;
                document.getElementById('modal-title').textContent = isEditMode ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ æ–°ç”¨æˆ·';
                const userInput = document.getElementById('modal-username');
                const rateInput = document.getElementById('modal-rate');
                const passwordInput = document.getElementById('modal-password');

                userInput.value = isEditMode ? username : '';
                userInput.disabled = isEditMode;
                rateInput.value = isEditMode ? window.allUsers[username].rate : '';
                passwordInput.value = '';
                passwordInput.placeholder = isEditMode ? 'ç•™ç©ºåˆ™ä¸ä¿®æ”¹' : 'è¯·è¾“å…¥å¯†ç ';
                
                userModal.classList.add('visible');
            };

            window.closeUserModal = () => {
                userModal.classList.remove('visible');
            };

            window.saveUser = async () => {
                const username = document.getElementById('modal-username').value;
                const password = document.getElementById('modal-password').value;
                const rate = parseFloat(document.getElementById('modal-rate').value);

                if (!username) { return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º'); }
                if (!isEditMode && !password) { return alert('æ–°ç”¨æˆ·å¿…é¡»è®¾ç½®å¯†ç '); }
                if (isNaN(rate) || rate < 0) { return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è´¹ç‡'); }

                const userData = { username, rate };
                if (password) {
                    userData.password = password;
                }

                const endpoint = isEditMode ? `/users/${editUsername}` : '/users';
                const method = isEditMode ? 'PUT' : 'POST';

                const result = await apiCall(endpoint, method, userData);
                if (result.success) {
                    alert(isEditMode ? 'ç”¨æˆ·æ›´æ–°æˆåŠŸ' : 'ç”¨æˆ·æ·»åŠ æˆåŠŸ');
                    closeUserModal();
                } else {
                    alert(`æ“ä½œå¤±è´¥: ${result.message}`);
                }
            };

            function connect() {
                let ws = new WebSocket(`ws://localhost:3000`);
                ws.onopen = () => {
                    statusEl.textContent = 'å·²è¿æ¥';
                    indicatorEl.className = 'network-indicator connected';
                    ws.send(JSON.stringify({ type: 'admin_login', username: 'admin', password: 'admin' }));
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'admin_update') updateUI(data);
                    if (data.type === 'ping') {
                        ws.send(JSON.stringify({ type: 'pong' }));
                    }
                    if (data.type === 'server_log') {
                        const serverLogEl = document.getElementById('server-log');
                        serverLogEl.textContent += data.message + '\n';
                        serverLogEl.scrollTop = serverLogEl.scrollHeight;
                    }
                };
                ws.onclose = () => {
                    statusEl.textContent = 'è¿æ¥å…³é—­';
                    indicatorEl.className = 'network-indicator error';
                    setTimeout(connect, 3000);
                };
                ws.onerror = () => {
                    statusEl.textContent = 'è¿æ¥é”™è¯¯';
                    indicatorEl.className = 'network-indicator error';
                    setTimeout(connect, 3000);
                };
            }
            connect();
            openView('console');
        });
    </script>
</body>
</html>
